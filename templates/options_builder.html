<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-leg Option Contract Graph</title>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"></script>
</head>
<body>
    <h1>Multi-leg Option Contract Graph</h1>

    <!-- Form to select contract parameters -->
    <form id="optionForm">
        <label for="symbol">Select Symbol:</label>
        <select id="symbol">
            <!-- Populate symbols dynamically based on available options -->
            {% for symbol in unique_symbols %}
                <option value="{{ symbol }}">{{ symbol }}</option>
            {% endfor %}
        </select>
        <label for="expirationDate">Select Expiration Date:</label>
        <select id="expirationDate">
            {% for expiration_date in expiration_dates %}
            <option value="{{ expiration_date }}">{{ expiration_date }}</option>
            {% endfor %}
        </select>

        <!-- Container to add and remove legs -->
        <div id="legsContainer">
            <div class="leg">
                <label>Select Leg Type:</label>
                <select class="legType">
                    <option value="Buy_Put">Buy Put</option>
                    <option value="Buy_Call">Buy Call</option>
                    <option value="Sell_Put">Sell Put</option>
                    <option value="Buy_Put">Buy Put</option>
                    <!-- Add other options for the leg type -->
                </select>
                <!-- Newly added dropdown for strike prices -->
                <label for="strikePrices">Select Strike Price:</label>
                <select id="strikePrices"></select>
                <button type="button" onclick="removeLeg(this)">Remove Leg</button>
            </div>
        </div>

        <!-- Button to add a new leg -->
        <button type="button" onclick="addLeg()">Add Leg</button>
        <button type="button" onclick="generateChart()">Generate Chart</button>
        <button type="button" onclick="goToOptions()">Back To Options Table</button>
    </form>

    <!-- Canvas to display the Chart -->
    <div style="width: 80%;">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        // Function to fetch and populate strike prices for a specific leg
        function fetchAndPopulateStrikePrices(selectedSymbol, strikePricesDropdown) {
            fetch(`/get_strike_prices?symbol=${selectedSymbol}`)
                .then(response => response.json())
                .then(data => {
                    strikePricesDropdown.innerHTML = '';

                    data.strikePrices.forEach(strikePrice => {
                        const option = document.createElement('option');
                        option.value = strikePrice;
                        option.text = strikePrice;
                        strikePricesDropdown.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching strike prices:', error);
                });
        }

        document.getElementById('symbol').addEventListener('change', function () {
            const selectedSymbol = this.value;
            const allLegStrikePriceDropdowns = document.querySelectorAll('.legStrikePrice');

            allLegStrikePriceDropdowns.forEach(strikePricesDropdown => {
                fetchAndPopulateStrikePrices(selectedSymbol, strikePricesDropdown);
            });
        });

        function addLeg() {
            const legsContainer = document.getElementById('legsContainer');
            const newLeg = document.createElement('div');
            newLeg.innerHTML = `
                <div class="leg">
                    <label>Select Leg Type:</label>
                    <select class="legType">
                        <option value="Buy_Put">Buy Put</option>
                        <option value="Sell_Put">Sell Put</option>
                        <option value="Buy_Call">Buy Call</option>
                        <option value="Sell_Call">Sell Call</option>
                        <!-- Add other options for the leg type -->
                    </select>
                    <label for="strikePrices">Select Strike Price:</label>
                    <select class="legStrikePrice"></select>
                    <button type="button" onclick="removeLeg(this)">Remove Leg</button>
                </div>
            `;
            legsContainer.appendChild(newLeg);

            // Fetch and populate the strike prices dropdown for the newly added leg
            const legStrikePriceDropdown = newLeg.querySelector('.legStrikePrice');
            const selectedSymbol = document.getElementById('symbol').value;

            fetchAndPopulateStrikePrices(selectedSymbol, legStrikePriceDropdown);
        }

        function removeLeg(button) {
            const legDiv = button.parentElement;
            legDiv.parentElement.removeChild(legDiv);
        }

        function generateChart() {
            const expirationDate = document.getElementById('expirationDate').value;
            const legs = document.querySelectorAll('.leg');
            const legData = [];

            // For each leg:
            legs.forEach((leg, index) => {
                console.log("LEG: " + leg)
                console.log("INDEX: " + index)
                const legType = leg.querySelector('.legType').value;
                // const strikePrice = // Get the strike price for the leg
                // const premiumPaid = // Get the premium paid for the leg

                const legDataPoints = [];
                for (let stockPrice = 0; stockPrice <= 100; stockPrice += 1) {
                    let profitLoss = 0;
                    if (legType === 'Buy_Call') {
                        profitLoss = Math.max(0, (stockPrice - strikePrice) - premiumPaid);
                    } else if (legType === 'Buy_Put') {
                        profitLoss = Math.max(0, (strikePrice - stockPrice) - premiumPaid);
                    } else if (legType === 'Sell_Call') {
                        profitLoss = Math.max(0, premiumPaid - (stockPrice - strikePrice));
                    } else if (legType === 'Sell_Put') {
                        profitLoss = Math.max(0, premiumPaid - (strikePrice - stockPrice));
                    }
                    legDataPoints.push(profitLoss);
                }

                legData.push({
                    label: `Leg ${index + 1} (${legType})`,
                    data: legDataPoints,
                    // Other dataset properties like colors, etc.
                });
            });

            // Prepare chart data using leg data points
            const chartData = {
                labels: Array.from({ length: 101 }, (_, i) => i), // Stock price labels from 0 to 100
                datasets: legData,
            };

            // Chart.js configuration
            const chartOptions = {
                // Chart configuration options
            };

            // Create and render the chart
            const ctx = document.getElementById('myChart').getContext('2d');
            const myChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: chartOptions
            });
        }

        function goToOptions() {
            console.log("OPTIONS PAGE")
            window.location.href = '/';
        }
    </script>
</body>
</html>
