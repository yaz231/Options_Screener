<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-leg Option Contract Graph</title>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"></script>
</head>
<body>
    <h1>Multi-leg Option Contract Graph</h1>

    <!-- Form to select contract parameters -->
    <form id="optionForm">
        <label for="symbol">Select Symbol:</label>
        <select id="symbol">
            <!-- Populate symbols dynamically based on available options -->
            {% for symbol in unique_symbols %}
                <option value="{{ symbol }}">{{ symbol }}</option>
            {% endfor %}
        </select>
        <label for="expirationDate">Select Expiration Date:</label>
        <select id="expirationDate">
            {% for expiration_date in expiration_dates %}
            <option value="{{ expiration_date }}">{{ expiration_date }}</option>
            {% endfor %}
        </select>

        <!-- Newly added dropdown for strike prices -->
        <label for="strikePrices">Select Strike Price:</label>
        <select id="strikePrices"></select>

        <!-- Container to add and remove legs -->
        <div id="legsContainer">
            <div class="leg">
                <label>Select Leg Type:</label>
                <select class="legType">
                    <option value="Put">Buy Put</option>
                    <option value="Call">Buy Call</option>
                    <!-- Add other options for the leg type -->
                </select>
                <button type="button" onclick="removeLeg(this)">Remove Leg</button>
            </div>
        </div>

        <!-- Button to add a new leg -->
        <button type="button" onclick="addLeg()">Add Leg</button>
        <button type="button" onclick="generateChart()">Generate Chart</button>
        <button type="button" onclick="goToOptions()">Back To Options Table</button>
    </form>

    <!-- Canvas to display the Chart -->
    <div style="width: 80%;">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        document.getElementById('symbol').addEventListener('change', function() {
            const selectedSymbol = this.value;

            fetch(`/get_strike_prices?symbol=${selectedSymbol}`)
                .then(response => response.json())
                .then(data => {
                    const strikePricesDropdown = document.getElementById('strikePrices');
                    strikePricesDropdown.innerHTML = '';

                    // Populate the strike prices dropdown with fetched data
                    data.strikePrices.forEach(strikePrice => {
                        const option = document.createElement('option');
                        option.value = strikePrice;
                        option.text = strikePrice;
                        strikePricesDropdown.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching strike prices:', error);
                });
        });
        function addLeg() {
            const legsContainer = document.getElementById('legsContainer');
            const newLeg = document.createElement('div');
            newLeg.innerHTML = `
                <div class="leg">
                    <label>Select Leg Type:</label>
                    <select class="legType">
                        <option value="Buy_Put">Buy Put</option>
                        <option value="Sell_Put">Sell Put</option>
                        <option value="Buy_Call">Buy Call</option>
                        <option value="Sell_Call">Sell Call</option>

                        <!-- Add other options for the leg type -->
                    </select>
                    <button type="button" onclick="removeLeg(this)">Remove Leg</button>
                </div>
            `;
            legsContainer.appendChild(newLeg);
        }

        function removeLeg(button) {
            const legDiv = button.parentElement;
            legDiv.parentElement.removeChild(legDiv);
        }

        function generateChart() {
            const expirationDate = document.getElementById('expirationDate').value;
            const legs = document.querySelectorAll('.leg');
            const legData = [];

            legs.forEach((leg, index) => {
                const legType = leg.querySelector('.legType').value;
                // Here, fetch other necessary data for the legs (e.g., strike price, quantity, etc.)
                // Replace the below example data with actual data for each leg
                const legDataPoint = [50 + index * 10, 60 + index * 10, 70 + index * 10];
                legData.push({
                    label: `Leg ${index + 1} (${legType})`,
                    backgroundColor: `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.2)`,
                    borderColor: `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 1)`,
                    borderWidth: 1,
                    data: legDataPoint,
                });
            });

            // Prepare chart data using leg data points
            const chartData = {
                labels: ["Price 1", "Price 2", "Price 3"], // Add appropriate labels for price points
                datasets: legData,
            };

            // Chart.js configuration
            const chartOptions = {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Price'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Profit/Loss'
                        }
                    }
                }
            };

            const ctx = document.getElementById('myChart').getContext('2d');
            const myChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: chartOptions
            });
        }

        function goToOptions() {
            console.log("OPTIONS PAGE")
            window.location.href = '/';
        }
    </script>
</body>
</html>
