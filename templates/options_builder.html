<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-leg Option Contract Graph</title>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"></script>
</head>
<body>
    <h1>Multi-leg Option Contract Graph</h1>

    <!-- Form to select contract parameters -->
    <form id="optionForm">
        <label for="symbol">Select Symbol:</label>
        <select id="symbol">
            <!-- Populate symbols dynamically based on available options -->
            {% for symbol in unique_symbols %}
                <option value="{{ symbol }}">{{ symbol }}</option>
            {% endfor %}
        </select>
        <label for="expirationDate">Select Expiration Date:</label>
        <select id="expirationDate">
            {% for expiration_date in expiration_dates %}
            <option value="{{ expiration_date }}">{{ expiration_date }}</option>
            {% endfor %}
        </select>

        <!-- Container to add and remove legs -->
        <div id="legsContainer">
<!--            <div class="leg">-->
<!--                <label>Select Leg Type:</label>-->
<!--                <select class="legType">-->
<!--                    <option value="Buy_Put">Buy Put</option>-->
<!--                    <option value="Buy_Call">Buy Call</option>-->
<!--                    <option value="Sell_Put">Sell Put</option>-->
<!--                    <option value="Sell_Call">Sell Call</option>-->
<!--                    &lt;!&ndash; Add other options for the leg type &ndash;&gt;-->
<!--                </select>-->
<!--                &lt;!&ndash; Newly added dropdown for strike prices &ndash;&gt;-->
<!--                <label for="strikePrices">Select Strike Price:</label>-->
<!--                <select id="strikePrices"></select>-->
<!--                <button type="button" onclick="removeLeg(this)">Remove Leg</button>-->
<!--            </div>-->
        </div>

        <!-- Button to add a new leg -->
        <button type="button" onclick="addLeg()">Add Leg</button>
        <button type="button" onclick="generateChart()">Generate Chart</button>
        <button type="button" onclick="goToOptions()">Back To Options Table</button>
    </form>

    <!-- Canvas to display the Chart -->
    <div style="width: 80%;">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        // Function to fetch and populate strike prices for a specific leg
        function fetchAndPopulateStrikePrices(selectedSymbol, strikePricesDropdown) {
            fetch(`/get_strike_prices?symbol=${selectedSymbol}`)
                .then(response => response.json())
                .then(data => {
                    strikePricesDropdown.innerHTML = '';

                    data.strikePrices.forEach(strikePrice => {
                        const option = document.createElement('option');
                        option.value = strikePrice;
                        option.text = `Strike Price: ${strikePrice} - Premium: ${data.strikePremiums[index]}`; // Show strike price with premium
                        strikePricesDropdown.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching strike prices:', error);
                });
        }

        document.getElementById('symbol').addEventListener('change', function () {
            const selectedSymbol = this.value;
            const allLegStrikePriceDropdowns = document.querySelectorAll('.legStrikePrice');

            allLegStrikePriceDropdowns.forEach(strikePricesDropdown => {
                fetchAndPopulateStrikePrices(selectedSymbol, strikePricesDropdown);
            });
        });

        function addLeg() {
            const legsContainer = document.getElementById('legsContainer');
            const newLeg = document.createElement('div');
            newLeg.innerHTML = `
                <div class="leg">
                    <label>Select Leg Type:</label>
                    <select class="legType">
                        <option value="Buy_Put">Buy Put</option>
                        <option value="Sell_Put">Sell Put</option>
                        <option value="Buy_Call">Buy Call</option>
                        <option value="Sell_Call">Sell Call</option>
                        <!-- Add other options for the leg type -->
                    </select>
                    <label for="strikePrices">Select Strike Price:</label>
                    <select class="legStrikePrice"></select>
                    <button type="button" onclick="removeLeg(this)">Remove Leg</button>
                </div>
            `;
            legsContainer.appendChild(newLeg);

            // Fetch and populate the strike prices dropdown for the newly added leg
            const legStrikePriceDropdown = newLeg.querySelector('.legStrikePrice');
            const selectedSymbol = document.getElementById('symbol').value;

            fetchAndPopulateStrikePrices(selectedSymbol, legStrikePriceDropdown);
        }
        // Fetch and populate strike prices for the initial leg when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            const initialLegStrikePriceDropdown = document.querySelector('.legStrikePrice');
            const selectedSymbol = document.getElementById('symbol').value;

            fetchAndPopulateStrikePrices(selectedSymbol, initialLegStrikePriceDropdown);
        });

        function removeLeg(button) {
            const legDiv = button.parentElement;
            legDiv.parentElement.removeChild(legDiv);
        }

        async function generateChart() {
            const expirationDate = document.getElementById('expirationDate').value;
            const legs = document.querySelectorAll('.leg');

            const selectedSymbol = document.getElementById('symbol').value;
            const currentStockPrice = await fetchCurrentStockPrice(selectedSymbol);

            // Calculate the range for the x-axis based on the current stock price, strike price, and some additional data
            const minStockPrice = currentStockPrice - 20; // 20 below the current stock price
            const maxStockPrice = currentStockPrice + 20; // 20 above the current stock price

            const chartData = {
                labels: Array.from({ length: maxStockPrice - minStockPrice + 1 }, (_, i) => minStockPrice + i), // Stock price labels from minStockPrice to maxStockPrice
                datasets: [],
            };

            // Iterate through each leg
            legs.forEach((leg, index) => {
                const legType = leg.querySelector('.legType').value;
                const selectedOption = leg.querySelector('.legStrikePrice').selectedOptions[0].text; // Get the selected option
                const [strikePrice, premium] = selectedOption.split(' - Premium: ')[0].split(': ')[1].split(' '); // Parse strike price and premium

                const legDataPoints = [];

                // Calculate profit/loss for each stock price in the range
                for (let stockPrice = minStockPrice; stockPrice <= maxStockPrice; stockPrice += 1) {
                    let legProfitLoss = 0;

                    if (legType === 'Buy_Call') {
                        legProfitLoss = Math.max(0, (stockPrice - Number(strikePrice)) - Number(premium));
                    } else if (legType === 'Buy_Put') {
                        legProfitLoss = Math.max(0, (Number(strikePrice) - stockPrice) - Number(premium));
                    } else if (legType === 'Sell_Call') {
                        legProfitLoss = Math.max(0, Number(premium) - (stockPrice - Number(strikePrice)));
                    } else if (legType === 'Sell_Put') {
                        legProfitLoss = Math.max(0, Number(premium) - (Number(strikePrice) - stockPrice));
                    }

                    legDataPoints.push(legProfitLoss); // Push profit/loss for each stock price
                }

                chartData.datasets.push({
                    label: `Leg ${index + 1} (${legType})`,
                    data: legDataPoints,
                    // Other dataset properties like colors, etc.
                });
            });

            // Chart.js configuration
            const chartOptions = {
                // Chart configuration options
            };

            // Create and render the chart
            const ctx = document.getElementById('myChart').getContext('2d');
            const myChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: chartOptions,
            });
        }

        function goToOptions() {
            console.log("OPTIONS PAGE")
            window.location.href = '/';
        }

        // Function to fetch the current stock price from the backend or an API
        async function fetchCurrentStockPrice(selectedSymbol) {
            const response = await fetch(`/get_current_stock_price?symbol=${selectedSymbol}`);
            const data = await response.json();
            return data.currentStockPrice;
        }
    </script>
</body>
</html>
